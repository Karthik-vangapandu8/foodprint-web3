<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/head') %>
    <title>üé§ Voice Harvest Entry - FoodPrint</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .voice-container {
            width: 90%;
            max-width: 600px;
            background: white;
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        .voice-icon {
            font-size: 120px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .title-large {
            font-size: 42px;
            font-weight: 800;
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 24px;
            color: #666;
            margin-bottom: 40px;
        }
        .instruction {
            font-size: 20px;
            color: #555;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .mic-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #f44336, #e91e63);
            color: white;
            font-size: 80px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(244, 67, 54, 0.4);
            transition: all 0.3s;
            margin: 30px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mic-button:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(244, 67, 54, 0.6);
        }
        .mic-button.listening {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 30px rgba(76, 175, 80, 0);
            }
        }
        .status-text {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
            margin: 30px 0;
            min-height: 40px;
        }
        .result-card {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            text-align: left;
            display: none;
        }
        .result-card.show {
            display: block;
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .result-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 12px;
            font-size: 20px;
        }
        .result-icon {
            font-size: 40px;
        }
        .result-label {
            font-weight: 700;
            color: #333;
        }
        .result-value {
            color: #667eea;
            font-weight: 600;
        }
        .action-buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        .btn-large {
            flex: 1;
            padding: 20px;
            font-size: 22px;
            font-weight: 700;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-save {
            background: #4CAF50;
            color: white;
        }
        .btn-save:hover {
            background: #45a049;
            transform: translateY(-3px);
        }
        .btn-retry {
            background: #ff9800;
            color: white;
        }
        .btn-retry:hover {
            background: #f57c00;
            transform: translateY(-3px);
        }
        .back-link {
            display: block;
            margin-top: 30px;
            font-size: 18px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        .example-text {
            background: #e8eaf6;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 18px;
            color: #5e35b1;
            font-style: italic;
        }
        .language-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <button class="language-switch" onclick="toggleLanguage()" id="langBtn">
        üåç ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä
    </button>

    <div class="voice-container">
        <div class="voice-icon">üé§</div>
        
        <h1 class="title-large" id="mainTitle">‡§¨‡•ã‡§≤‡•á‡§Ç</h1>
        <p class="subtitle" id="subtitle">Speak Naturally</p>
        
        <p class="instruction" id="instruction">
            ‡§¨‡§∏ ‡§¨‡•ã‡§≤‡•á‡§Ç: "‡§Æ‡•à‡§Ç‡§®‡•á ‡§Ü‡§ú 100 ‡§ï‡§ø‡§≤‡•ã ‡§ü‡§Æ‡§æ‡§ü‡§∞ ‡§ï‡§æ‡§ü‡•á"<br>
            <small style="color: #999;">Just say: "I harvested 100 kg tomatoes today"</small>
        </p>

        <div class="example-text" id="examples">
            <strong>‡§â‡§¶‡§æ‡§π‡§∞‡§£ | Examples:</strong><br>
            "100 ‡§ï‡§ø‡§≤‡•ã ‡§ü‡§Æ‡§æ‡§ü‡§∞" | "50 kg potatoes"<br>
            "2 ‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤ ‡§ó‡•á‡§π‡•Ç‡§Ç" | "1 ton wheat"
        </div>

        <button class="mic-button" id="micBtn" onclick="startListening()">
            üé§
        </button>

        <div class="status-text" id="statusText">
            ‡§Æ‡§æ‡§á‡§ï ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç | Click the Mic
        </div>

        <!-- Results Card -->
        <div class="result-card" id="resultCard">
            <div class="result-item">
                <span class="result-icon">üåæ</span>
                <div style="flex: 1;">
                    <div class="result-label">‡§´‡§∏‡§≤ | Crop:</div>
                    <div class="result-value" id="cropResult">-</div>
                </div>
            </div>
            <div class="result-item">
                <span class="result-icon">‚öñÔ∏è</span>
                <div style="flex: 1;">
                    <div class="result-label">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ | Quantity:</div>
                    <div class="result-value" id="quantityResult">-</div>
                </div>
            </div>
            <div class="result-item">
                <span class="result-icon">üìÖ</span>
                <div style="flex: 1;">
                    <div class="result-label">‡§§‡§æ‡§∞‡•Ä‡§ñ | Date:</div>
                    <div class="result-value" id="dateResult">-</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-large btn-retry" onclick="retry()">
                    üîÑ ‡§´‡§ø‡§∞ ‡§∏‡•á | Try Again
                </button>
                <button class="btn-large btn-save" onclick="saveHarvest()">
                    ‚úÖ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç | Save
                </button>
            </div>
        </div>

        <a href="/app/harvest" class="back-link">‚Üê ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç | Go Back</a>
    </div>

    <%- include('partials/scripts') %>
    
    <script>
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let currentLanguage = 'hi-IN'; // Default Hindi
        let harvestData = {};

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'hi-IN' ? 'en-US' : 'hi-IN';
            const btn = document.getElementById('langBtn');
            btn.textContent = currentLanguage === 'hi-IN' ? 'üåç English' : 'üåç ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä';
            
            // Speak confirmation
            const msg = currentLanguage === 'hi-IN' ? '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§¨‡•ã‡§≤‡•á‡§Ç' : 'Speak in English';
            speak(msg);
        }

        function startListening() {
            if (!recognition) {
                alert('‚ö†Ô∏è Voice not supported. Please use Chrome or Edge.');
                return;
            }

            const micBtn = document.getElementById('micBtn');
            const statusText = document.getElementById('statusText');
            const resultCard = document.getElementById('resultCard');

            // Hide previous results
            resultCard.classList.remove('show');

            // Set language
            recognition.lang = currentLanguage;

            // Visual feedback
            micBtn.classList.add('listening');
            statusText.textContent = currentLanguage === 'hi-IN' ? 
                '‡§∏‡•Å‡§® ‡§∞‡§π‡•á ‡§π‡•à‡§Ç... üéß' : 'Listening... üéß';

            // Handle result
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;

                console.log('Transcript:', transcript);
                console.log('Confidence:', confidence);

                // Process the speech
                processHarvestSpeech(transcript);

                // Reset button
                micBtn.classList.remove('listening');
                statusText.textContent = currentLanguage === 'hi-IN' ? 
                    '‚úÖ ‡§™‡•Ç‡§∞‡•ç‡§£ | Done!' : '‚úÖ Complete!';
            };

            recognition.onerror = function(event) {
                console.error('Speech error:', event.error);
                micBtn.classList.remove('listening');
                statusText.textContent = '‚ùå ' + (currentLanguage === 'hi-IN' ? 
                    '‡§ï‡•Å‡§õ ‡§ó‡§≤‡§§ ‡§π‡•Å‡§Ü' : 'Something went wrong');
                speak(currentLanguage === 'hi-IN' ? '‡§ï‡•Å‡§õ ‡§ó‡§≤‡§§ ‡§π‡•Å‡§Ü‡•§ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§' : 'Error. Please try again.');
            };

            recognition.onend = function() {
                micBtn.classList.remove('listening');
            };

            // Start recognition
            try {
                recognition.start();
                speak(currentLanguage === 'hi-IN' ? '‡§¨‡•ã‡§≤‡•á‡§Ç' : 'Speak now');
            } catch (error) {
                console.error('Failed to start:', error);
                alert('‡§Æ‡§æ‡§á‡§ï ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç | Please allow microphone access');
            }
        }

        function processHarvestSpeech(text) {
            // Extract crop, quantity, and unit from natural speech
            const lowerText = text.toLowerCase();
            
            // Crop mapping (Hindi & English)
            const crops = {
                '‡§ü‡§Æ‡§æ‡§ü‡§∞': 'Tomato',
                'tomato': 'Tomato',
                'tomatoes': 'Tomato',
                '‡§Ü‡§≤‡•Ç': 'Potato',
                'potato': 'Potato',
                'potatoes': 'Potato',
                '‡§ó‡•á‡§π‡•Ç‡§Ç': 'Wheat',
                'wheat': 'Wheat',
                '‡§™‡•ç‡§Ø‡§æ‡§ú': 'Onion',
                'onion': 'Onion',
                'onions': 'Onion',
                '‡§ó‡§æ‡§ú‡§∞': 'Carrot',
                'carrot': 'Carrot',
                'carrots': 'Carrot',
                '‡§¨‡•à‡§Ç‡§ó‡§®': 'Brinjal',
                'brinjal': 'Brinjal',
                'eggplant': 'Brinjal',
                '‡§™‡§§‡•ç‡§§‡§æ‡§ó‡•ã‡§≠‡•Ä': 'Cabbage',
                'cabbage': 'Cabbage',
                '‡§Æ‡§ø‡§∞‡•ç‡§ö': 'Chilli',
                'chilli': 'Chilli',
                'chili': 'Chilli',
                'pepper': 'Chilli'
            };

            // Find crop
            let crop = 'Unknown';
            for (let [key, value] of Object.entries(crops)) {
                if (lowerText.includes(key)) {
                    crop = value;
                    break;
                }
            }

            // Extract numbers
            const numbers = text.match(/\d+/g);
            let quantity = numbers ? numbers[0] : '0';

            // Extract unit
            let unit = 'kg';
            if (lowerText.includes('‡§ï‡§ø‡§≤‡•ã') || lowerText.includes('kg') || lowerText.includes('kilogram')) {
                unit = 'kg';
            } else if (lowerText.includes('‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤') || lowerText.includes('quintal')) {
                unit = 'quintal';
            } else if (lowerText.includes('‡§ü‡§®') || lowerText.includes('ton')) {
                unit = 'ton';
            }

            // Store data
            harvestData = {
                crop: crop,
                quantity: quantity,
                unit: unit,
                date: new Date().toISOString().split('T')[0],
                rawText: text
            };

            // Show results
            showResults();
        }

        function showResults() {
            document.getElementById('cropResult').textContent = harvestData.crop;
            document.getElementById('quantityResult').textContent = harvestData.quantity + ' ' + harvestData.unit;
            document.getElementById('dateResult').textContent = new Date().toLocaleDateString('en-IN');

            document.getElementById('resultCard').classList.add('show');

            // Speak confirmation
            const msg = currentLanguage === 'hi-IN' ? 
                `${harvestData.quantity} ${harvestData.unit} ${harvestData.crop}. ‡§∏‡§π‡•Ä ‡§π‡•à?` :
                `${harvestData.quantity} ${harvestData.unit} of ${harvestData.crop}. Correct?`;
            speak(msg);
        }

        function retry() {
            document.getElementById('resultCard').classList.remove('show');
            document.getElementById('statusText').textContent = currentLanguage === 'hi-IN' ? 
                '‡§Æ‡§æ‡§á‡§ï ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç' : 'Click the Mic';
            speak(currentLanguage === 'hi-IN' ? '‡§´‡§ø‡§∞ ‡§∏‡•á ‡§¨‡•ã‡§≤‡•á‡§Ç' : 'Speak again');
        }

        function saveHarvest() {
            if (!harvestData.crop || harvestData.crop === 'Unknown') {
                alert('‚ùå ‡§´‡§∏‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§');
                return;
            }

            // Show loading
            document.getElementById('statusText').textContent = '‚è≥ ‡§∏‡§π‡•á‡§ú ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...';

            // Prepare form data
            const formData = new FormData();
            formData.append('viewmodal_harvest_suppliershortcode', 'VOICE');
            formData.append('viewmodal_harvest_suppliername', '<%= user.firstName %> <%= user.lastName %> Farm');
            formData.append('viewmodal_harvest_supplieraddress', 'Voice Entry');
            formData.append('viewmodal_harvest_producename', harvestData.crop);
            formData.append('viewmodal_supplierproduce', harvestData.crop + '_VOICE');
            formData.append('viewmodal_harvest_timestamp', harvestData.date);
            formData.append('viewmodal_harvest_description', 'Voice entry: ' + harvestData.rawText);
            formData.append('viewmodal_harvest_geolocation', '0,0');
            formData.append('viewmodal_harvest_quantity', harvestData.quantity);
            formData.append('viewmodal_harvest_unitofmeasure', harvestData.unit);

            // Submit to backend
            fetch('/app/harvest/save', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    // Success - follow redirect
                    window.location.href = response.url;
                } else {
                    return response.text();
                }
            })
            .then(html => {
                if (html) {
                    // Success
                    speak(currentLanguage === 'hi-IN' ? '‡§´‡§∏‡§≤ ‡§∏‡§π‡•á‡§ú‡•Ä ‡§ó‡§à' : 'Harvest saved');
                    setTimeout(() => {
                        window.location.href = '/app/harvest';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error saving. Please try again.');
                document.getElementById('statusText').textContent = '‚ùå Error';
            });
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = currentLanguage;
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        }

        // Welcome message
        setTimeout(() => {
            speak(currentLanguage === 'hi-IN' ? 
                '‡§®‡§Æ‡§∏‡•ç‡§§‡•á <%= user.firstName %>‡•§ ‡§Ö‡§™‡§®‡•Ä ‡§´‡§∏‡§≤ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§' :
                'Hello <%= user.firstName %>. Speak your harvest details.');
        }, 1000);
    </script>
</body>
</html>

